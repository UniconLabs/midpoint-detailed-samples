<resource xmlns="http://midpoint.evolveum.com/xml/ns/public/common/common-3" xmlns:c="http://midpoint.evolveum.com/xml/ns/public/common/common-3" xmlns:icfs="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/resource-schema-3" xmlns:org="http://midpoint.evolveum.com/xml/ns/public/common/org-3" xmlns:q="http://prism.evolveum.com/xml/ns/public/query-3" xmlns:ri="http://midpoint.evolveum.com/xml/ns/public/resource/instance-3" xmlns:t="http://prism.evolveum.com/xml/ns/public/types-3" oid="f70b98d2-cebd-4d44-abb4-9a2a3bdb44ba" version="59">
    <name>Outbound Cloud CSV App</name>
    <description>Outbound App That Consumes CSV from Cloud Object Storage</description>
    <iteration>0</iteration>
    <iterationToken/>
    <connectorRef oid="6aed59ce-0608-473d-92bb-2559c07eb2c2" relation="org:default" type="c:ConnectorType">
        <!-- ConnId com.evolveum.polygon.connector.cloud.objectstorage.csv.CloudCsvObjectStorageConnector v1.0 -->
    </connectorRef>
    <connectorConfiguration xmlns:icfc="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/connector-schema-3">
        <icfc:configurationProperties xmlns:gen737="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/bundle/com.evolveum.polygon.connector-cloud-csv/com.evolveum.polygon.connector.cloud.objectstorage.csv.CloudCsvObjectStorageConnector">
            <gen737:cloudObjectStorageProvider>s3</gen737:cloudObjectStorageProvider>
            <gen737:region>us-east-2</gen737:region>
            <gen737:bucketName>BUCKET_HERE</gen737:bucketName>
            <gen737:fileName>something/test1.csv</gen737:fileName>
            <gen737:accessKey>ACCESS_KEY_HERE</gen737:accessKey>
            <gen737:secretKey>__PASSWORD GOES HERE__</gen737:secretKey>
            <gen737:uniqueAttribute>USER_ID</gen737:uniqueAttribute>
            <gen737:fieldDelimiter>,</gen737:fieldDelimiter>
            <gen737:ignoreEmptyLines>true</gen737:ignoreEmptyLines>
            <gen737:trim>true</gen737:trim>
            <gen737:multivalueDelimiter>;;</gen737:multivalueDelimiter>
            <gen737:headerExists>true</gen737:headerExists>
            <gen737:readOnly>false</gen737:readOnly>
            <gen737:multivalueAttributes>SECTION_ID</gen737:multivalueAttributes>
            <gen737:testMode>false</gen737:testMode>
        </icfc:configurationProperties>
    </connectorConfiguration>
    <schema>
    </schema>
    <schemaHandling>
        <objectType id="2">
            <kind>account</kind>
            <default>true</default>
            <objectClass>ri:AccountObjectClass</objectClass>
            <attribute id="3">
                <c:ref xmlns:ri="http://midpoint.evolveum.com/xml/ns/public/resource/instance-3">ri:USER_ID</c:ref>
                <tolerant>true</tolerant>
                <exclusiveStrong>false</exclusiveStrong>
                <outbound>
                    <authoritative>true</authoritative>
                    <exclusive>false</exclusive>
                    <strength>normal</strength>
                    <source>
                        <c:path>extension/wiscEduPVI</c:path>
                    </source>
                </outbound>
            </attribute>
            <attribute id="5">
                <c:ref xmlns:ri="http://midpoint.evolveum.com/xml/ns/public/resource/instance-3">ri:ROOT_ACCOUNT</c:ref>
                <tolerant>true</tolerant>
                <exclusiveStrong>false</exclusiveStrong>
                <outbound>
                    <authoritative>true</authoritative>
                    <exclusive>false</exclusive>
                    <strength>normal</strength>
                    <expression>
                        <value>null</value>
                    </expression>
                </outbound>
            </attribute>
            <attribute id="6">
                <c:ref xmlns:ri="http://midpoint.evolveum.com/xml/ns/public/resource/instance-3">ri:ROLE</c:ref>
                <tolerant>true</tolerant>
                <exclusiveStrong>false</exclusiveStrong>
                <outbound>
                    <authoritative>true</authoritative>
                    <exclusive>false</exclusive>
                    <strength>normal</strength>
                    <expression>
                        <value>student</value>
                    </expression>
                </outbound>
            </attribute>
            <attribute id="7">
                <c:ref xmlns:ri="http://midpoint.evolveum.com/xml/ns/public/resource/instance-3">ri:ROLE_ID</c:ref>
                <tolerant>true</tolerant>
                <exclusiveStrong>false</exclusiveStrong>
                <outbound>
                    <authoritative>true</authoritative>
                    <exclusive>false</exclusive>
                    <strength>normal</strength>
                    <expression>
                        <value>null</value>
                    </expression>
                </outbound>
            </attribute>
            <attribute id="8">
                <c:ref xmlns:ri="http://midpoint.evolveum.com/xml/ns/public/resource/instance-3">ri:SECTION_ID</c:ref>
                <tolerant>true</tolerant>
                <exclusiveStrong>false</exclusiveStrong>
                <outbound>
                    <source>
                        <c:path>$user/name</c:path>
                    </source>
                    <expression>
                        <script xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="c:ScriptExpressionEvaluatorType">
                            <code>
                                import com.evolveum.midpoint.util.exception.ObjectNotFoundException
                                import com.evolveum.midpoint.xml.ns._public.common.common_3.AssignmentType
                                import com.evolveum.midpoint.xml.ns._public.common.common_3.ObjectReferenceType
                                import com.evolveum.midpoint.xml.ns._public.common.common_3.OrgType
                                import com.evolveum.midpoint.model.api.expr.MidpointFunctions
                                import com.evolveum.midpoint.util.QNameUtil

                                log.debug("Calculating Section Ids for " + name + "...")
                                def orgsToSectionMap = [
                                        // NOTE: this is NOT the grouper group name...it is the midpoint org name. 
                                        "Training Athletics"                                  : "ATH1",
                                        "Training School of Nursing"                          : "NURS",
                                        "Training Students (Pharmacy)"                        : "PHARM",
                                        "Training Students (Medicine)"                        : "MED",
                                        "Training Students (Nursing)"                         : "SNURS"
                                ]

                                def sectionIds = []
                                for (def assignment : user?.getAssignment()) {
                                    def ref = assignment?.getTargetRef()

                                    if (ref != null &amp;&amp; QNameUtil.match(ref?.getType(), OrgType.COMPLEX_TYPE)) {
                                        try {
                                           def org = midpoint.getObject(OrgType.class, ref?.getOid())
                                              if (org != null) {
                                               def orgName = org?.getName()?.toString()
                                               log.trace("Checking orgsToSectionMap for org name [" + orgName + "]")
                                                  if (orgsToSectionMap.containsKey(orgName)) {
                                                   log.trace("Adding org name " + orgName + " to user's section Id list!")
                                                   sectionIds.add(orgsToSectionMap.get(orgName))
                                               }
                                           }
                                        } catch (ObjectNotFoundException e) {
                                            log.trace("Error couldn't retrieve object with oid: " + ref?.getOid() + e);
                                        }
                                    }
                                }

                                def sectionIdReturnValue = String.join(";;", sectionIds)
                                log.debug("Returning " + sectionIdReturnValue + " for " + name + "'s SECTION_ID field!")
                                //return sectionIdReturnValue
                                // Possible problem with returning as a string instead of a list?
                                // It looks like the problem is that its returning a single valued attribute with semicolons
                                // so it thinks it needs to add "potato;;carrot" even though parrot, carrot is there.
                                // midpoint can handle either a list or a scaler returned. 
                                // Then we see it just constantly adding values each runs. 
                                // TODO: does it need to be a list or is an array fine?
                                return sectionIds as Set
                            </code>
                        </script>
                    </expression>
                </outbound>
            </attribute>
            <attribute id="9">
                <c:ref xmlns:ri="http://midpoint.evolveum.com/xml/ns/public/resource/instance-3">ri:STATUS</c:ref>
                <tolerant>true</tolerant>
                <exclusiveStrong>false</exclusiveStrong>
                <outbound>
                    <authoritative>true</authoritative>
                    <exclusive>false</exclusive>
                    <strength>normal</strength>
                    <expression>
                        <value>active</value>
                    </expression>
                </outbound>
            </attribute>
            <attribute id="10">
                <c:ref xmlns:ri="http://midpoint.evolveum.com/xml/ns/public/resource/instance-3">ri:ASSOCIATE_USER_ID</c:ref>
                <tolerant>true</tolerant>
                <exclusiveStrong>false</exclusiveStrong>
                <outbound>
                    <authoritative>true</authoritative>
                    <exclusive>false</exclusive>
                    <strength>normal</strength>
                    <expression>
                        <value>null</value>
                    </expression>
                </outbound>
            </attribute>
        </objectType>
    </schemaHandling>
    <capabilities>
        <native xmlns:cap="http://midpoint.evolveum.com/xml/ns/public/resource/capabilities-3">
            <cap:schema/>
            <cap:liveSync/>
            <cap:testConnection/>
            <cap:create/>
            <cap:update>
                <cap:addRemoveAttributeValues>true</cap:addRemoveAttributeValues>
            </cap:update>
            <cap:delete/>
            <cap:script>
                <cap:host>
                    <cap:type>resource</cap:type>
                </cap:host>
                <cap:host>
                    <cap:type>connector</cap:type>
                </cap:host>
            </cap:script>
            <cap:read>
                <cap:returnDefaultAttributesOption>false</cap:returnDefaultAttributesOption>
            </cap:read>
        </native>
        <configured xmlns:cap="http://midpoint.evolveum.com/xml/ns/public/resource/capabilities-3">
            <cap:liveSync>
                <cap:enabled>true</cap:enabled>
            </cap:liveSync>
            <cap:testConnection>
                <cap:enabled>true</cap:enabled>
            </cap:testConnection>
            <cap:create>
                <cap:enabled>true</cap:enabled>
            </cap:create>
            <cap:update>
                <cap:enabled>true</cap:enabled>
                <cap:addRemoveAttributeValues>true</cap:addRemoveAttributeValues>
            </cap:update>
            <cap:delete>
                <cap:enabled>true</cap:enabled>
            </cap:delete>
            <cap:script>
                <cap:enabled>true</cap:enabled>
                <cap:host>
                    <cap:type>resource</cap:type>
                </cap:host>
                <cap:host>
                    <cap:type>connector</cap:type>
                </cap:host>
            </cap:script>
            <cap:read>
                <cap:enabled>true</cap:enabled>
                <cap:returnDefaultAttributesOption>false</cap:returnDefaultAttributesOption>
            </cap:read>
        </configured>
    </capabilities>
    <synchronization>
        <objectSynchronization>
            <objectClass>AccountObjectClass</objectClass>
            <kind>account</kind>
            <focusType>c:UserType</focusType>
            <enabled>true</enabled>
            <correlation>
                <q:equal xmlns="">
                    <q:path>extension/netId</q:path>
                    <expression xmlns="">
                        <path>$projection/attributes/USER_ID</path>
                    </expression>
                </q:equal>
            </correlation>
            <reconcile>true</reconcile>
            <reaction>
                <situation>linked</situation>
                <synchronize>true</synchronize>
            </reaction>
            <reaction>
                <situation>deleted</situation>
                <synchronize>true</synchronize>
                <action>
                    <handlerUri>http://midpoint.evolveum.com/xml/ns/public/model/action-3#deleteFocus</handlerUri>
                </action>
            </reaction>
            <reaction>
                <situation>unlinked</situation>
                <action>
                    <handlerUri>http://midpoint.evolveum.com/xml/ns/public/model/action-3#link</handlerUri>
                </action>
            </reaction>
            <reaction>
                <situation>unmatched</situation>
                <action>
                    <handlerUri>http://midpoint.evolveum.com/xml/ns/public/model/action-3#addFocus</handlerUri>
                </action>
            </reaction>
        </objectSynchronization>
    </synchronization>
</resource>
