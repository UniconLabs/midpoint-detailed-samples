<?xml version="1.0" encoding="UTF-8"?>
<objects xmlns="http://midpoint.evolveum.com/xml/ns/public/common/common-3"
         xmlns:c="http://midpoint.evolveum.com/xml/ns/public/common/common-3"
         xmlns:org="http://midpoint.evolveum.com/xml/ns/public/common/org-3">
    <resource xmlns="http://midpoint.evolveum.com/xml/ns/public/common/common-3"
              xmlns:c="http://midpoint.evolveum.com/xml/ns/public/common/common-3"
              xmlns:icfs="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/resource-schema-3"
              xmlns:org="http://midpoint.evolveum.com/xml/ns/public/common/org-3"
              xmlns:q="http://prism.evolveum.com/xml/ns/public/query-3"
              xmlns:ri="http://midpoint.evolveum.com/xml/ns/public/resource/instance-3"
              xmlns:t="http://prism.evolveum.com/xml/ns/public/types-3"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              oid="386bf56f-87a2-4496-9cdb-db18729da89a"
              version="1">
        <name>Inbound Grouper Groups</name>
        <description>Pulls Grouper Group Memberships from an intermediate database table that's populated with group memberships from a Grouper SQL Provisioner.</description>
        <connectorRef relation="org:default" type="c:ConnectorType">
            <description>
                Use Scripted SQL Connector
            </description>
            <filter>
                <q:equal>
                    <q:path>connectorType</q:path>
                    <q:value>com.evolveum.polygon.connector.scripted.sql.ScriptedSQLConnector</q:value>
                </q:equal>
            </filter>
        </connectorRef>
        <connectorConfiguration xmlns:icfc="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/connector-schema-3">
            <icfc:configurationProperties xmlns:icscscriptedsql="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/bundle/com.evolveum.polygon.connector-scripted-sql/com.evolveum.polygon.connector.scripted.sql.ScriptedSQLConnector">
                <icscscriptedsql:scriptRoots>/opt/midpoint/var/sql-scripts/grouper-groups/</icscscriptedsql:scriptRoots>
                <icscscriptedsql:classpath>.</icscscriptedsql:classpath>
                <icscscriptedsql:scriptBaseClass>BaseScript</icscscriptedsql:scriptBaseClass>
                <icscscriptedsql:searchScriptFileName>SearchScript.groovy</icscscriptedsql:searchScriptFileName>
                <icscscriptedsql:schemaScriptFileName>SchemaScript.groovy</icscscriptedsql:schemaScriptFileName>
                <icscscriptedsql:testScriptFileName>TestScript.groovy</icscscriptedsql:testScriptFileName>
                <icscscriptedsql:syncScriptFileName>SyncScript.groovy</icscscriptedsql:syncScriptFileName>
                <icscscriptedsql:user>${GPR_SUBJ_SRC_DB_USER}</icscscriptedsql:user>
                <icscscriptedsql:password>${GPR_SUBJ_SRC_DB_PASSWORD}</icscscriptedsql:password>
                <icscscriptedsql:jdbcDriver>org.postgresql.Driver</icscscriptedsql:jdbcDriver>
                <icscscriptedsql:jdbcUrlTemplate xmlns="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/bundle/com.evolveum.polygon.connector-scripted-sql/com.evolveum.polygon.connector.scripted.sql.ScriptedSQLConnector" xmlns:a="http://prism.evolveum.com/xml/ns/public/annotation-3">jdbc:postgresql://${GPR_SUBJ_SRC_DB_SERVER}:${GPR_SUBJ_SRC_DB_PORT}/${GPR_SUBJ_SRC_DB_NAME}</icscscriptedsql:jdbcUrlTemplate>
            </icfc:configurationProperties>
            <icfc:resultsHandlerConfiguration>
                <icfc:enableNormalizingResultsHandler>false</icfc:enableNormalizingResultsHandler>
                <icfc:enableFilteredResultsHandler>false</icfc:enableFilteredResultsHandler>
                <icfc:enableAttributesToGetSearchResultsHandler>false</icfc:enableAttributesToGetSearchResultsHandler>
                <icfc:filteredResultsHandlerInValidationMode>true</icfc:filteredResultsHandlerInValidationMode>
            </icfc:resultsHandlerConfiguration>
            <icfc:timeouts>
                <icfc:create>180000</icfc:create>
                <icfc:get>180000</icfc:get>
                <icfc:update>180000</icfc:update>
                <icfc:delete>180000</icfc:delete>
                <icfc:test>60000</icfc:test>
                <icfc:scriptOnConnector>180000</icfc:scriptOnConnector>
                <icfc:scriptOnResource>180000</icfc:scriptOnResource>
                <icfc:authentication>60000</icfc:authentication>
                <icfc:search>180000</icfc:search>
                <icfc:validate>180000</icfc:validate>
                <icfc:sync>180000</icfc:sync>
                <icfc:schema>60000</icfc:schema>
            </icfc:timeouts>
        </connectorConfiguration>
        <schema></schema>
        <schemaHandling>
            <objectType>
                <kind>account</kind>
                <default>true</default>
                <objectClass>ri:AccountObjectClass</objectClass>
                <attribute>
                <ref>ri:grouperSubjectId</ref>
                    <tolerant>true</tolerant>
                    <exclusiveStrong>false</exclusiveStrong>
                    <inbound>
                        <authoritative>true</authoritative>
                        <exclusive>false</exclusive>
                        <strength>weak</strength>
                        <target>
                            <path>name</path>
                        </target>
                    </inbound>
                    <outbound>
                        <authoritative>true</authoritative>
                        <exclusive>false</exclusive>
                        <strength>weak</strength>
                        <source>
                            <path>name</path>
                        </source>
                    </outbound>
                </attribute>
                <attribute>
                    <ref>ri:grouperGroupMembershipNames</ref>
                    <limitations>
                        <maxOccurs>unbounded</maxOccurs>
                    </limitations>
                    <inbound>
                        <authoritative>true</authoritative>
                        <exclusive>false</exclusive>
                        <strength>strong</strength>
                        <expression>
                        <assignmentTargetSearch>
                                <targetType>c:OrgType</targetType>
                                <filter>
                                    <q:equal xmlns="">
                                        <q:path>c:name</q:path>
                                        <expression xmlns="">
                                            <script xmlns="">
                                                <code>input</code>
                                                </script>
                                        </expression>
                                    </q:equal>
                                </filter>
                                <createOnDemand>true</createOnDemand>
                                <populateObject>
                                    <populateItem>
                                        <expression>
                                            <script>
                                            <code>input</code>
                                            </script>
                                        </expression>
                                        <target>
                                            <path>name</path>
                                        </target>
                                    </populateItem>
                                    <populateItem>
                                        <expression>
                                            <assignmentTargetSearch>
                                                <targetType>ArchetypeType</targetType>
                                                <oid>81f30e37-f7d5-4153-9c96-f049dd144e19</oid>
                                            </assignmentTargetSearch>
                                        </expression>
                                        <target>
                                            <path>assignment</path>
                                        </target>
                                    </populateItem>
                                </populateObject>
                                <assignmentProperties xsi:type="c:AssignmentPropertiesSpecificationType">
                                    <subtype>group-member</subtype>
                                </assignmentProperties>
                            </assignmentTargetSearch>
                        </expression>
                        <target>
                            <path>assignment</path>
                        </target>
                    </inbound>
                </attribute>
            </objectType>
            <objectType>
                <kind>generic</kind>
                <default>true</default>
                <objectClass>ri:CustomGroupObjectClass</objectClass>
                <attribute>
                    <ref>icfs:name</ref>
                    <outbound>
                        <source>
                            <path>name</path>
                        </source>
                    </outbound>
                    <inbound>
                        <authoritative>true</authoritative>
                        <exclusive>false</exclusive>
                        <strength>strong</strength>
                        <target>
                            <path>name</path>
                        </target>
                    </inbound>
                    <inbound>
                        <authoritative>true</authoritative>
                        <exclusive>false</exclusive>
                        <strength>strong</strength>
                        <expression>
                            <script>
                                <code>
                                    def orgName = input?.trim()
                                    if (orgName.contains(":")) {
                                        orgName = orgName.substring(orgName.lastIndexOf(":")+1,orgName.length())
                                    }
                                    return orgName
                                </code>
                            </script>
                        </expression>
                        <target>
                            <path>displayName</path>
                        </target>
                    </inbound>
                    <inbound>
                        <authoritative>true</authoritative>
                        <exclusive>false</exclusive>
                        <strength>strong</strength>
                        <expression>
                            <assignmentTargetSearch>
                                <targetType>c:ArchetypeType</targetType>
                                <oid>81f30e37-f7d5-4153-9c96-f049dd144e19</oid>
                            </assignmentTargetSearch>
                        </expression>
                        <target>
                            <path>assignment</path>
                        </target>
                    </inbound>
                </attribute>
                <attribute>
                    <ref>ri:groupParentId</ref>
                    <inbound>
                        <authoritative>true</authoritative>
                        <exclusive>false</exclusive>
                        <strength>strong</strength>
                        <target>
                            <path>extension/grouperParentName</path>
                        </target>
                    </inbound>
                    <inbound>
                        <authoritative>true</authoritative>
                        <exclusive>false</exclusive>
                        <strength>strong</strength>
                        <expression>
                            <assignmentTargetSearch>
                                <targetType>c:OrgType</targetType>
                                <filter>
                                    <q:equal xmlns="">
                                        <q:path>c:name</q:path>
                                        <expression xmlns="">
                                            <script xmlns="">
                                                <code>input</code>
                                            </script>
                                        </expression>
                                    </q:equal>
                                </filter>
                                <assignmentProperties xsi:type="c:AssignmentPropertiesSpecificationType">
                                    <subtype>group-group</subtype>
                                </assignmentProperties>
                            </assignmentTargetSearch>
                        </expression>
                        <target>
                            <path>assignment</path>
                        </target>
                    </inbound>
                </attribute>
            </objectType>
        </schemaHandling>
        <capabilities xmlns:cap="http://midpoint.evolveum.com/xml/ns/public/resource/capabilities-3">
            <configured>
                <cap:pagedSearch>
                    <cap:enabled>false</cap:enabled>
                </cap:pagedSearch>
                <cap:countObjects>
                    <cap:enabled>false</cap:enabled>
                </cap:countObjects>
                <cap:create>
                    <cap:enabled>true</cap:enabled>
                </cap:create>
                <cap:update>
                    <cap:enabled>true</cap:enabled>
                </cap:update>
                <cap:delete>
                    <cap:enabled>true</cap:enabled>
                </cap:delete>
                <!--
                <cap:addRemoveAttributeValues>
                    <cap:enabled>false</cap:enabled>
                </cap:addRemoveAttributeValues>
                -->
                <cap:liveSync>
                    <cap:preciseTokenValue>true</cap:preciseTokenValue>
                </cap:liveSync>
            </configured>
        </capabilities>
        <synchronization>
            <objectSynchronization>
                <objectClass>AccountObjectClass</objectClass>
                <kind>account</kind>
                <focusType>c:UserType</focusType>
                <enabled>true</enabled>
                <correlation>
                    <q:equal xmlns="">
                        <q:path>name</q:path>
                        <expression xmlns="">
                            <path>$projection/attributes/grouperSubjectId</path>
                        </expression>
                    </q:equal>
                </correlation>
                <reaction>
                    <situation>linked</situation>
                    <synchronize>true</synchronize>
                </reaction>
                <reaction>
                    <situation>unlinked</situation>
                    <synchronize>true</synchronize>
                    <action>
                        <handlerUri>http://midpoint.evolveum.com/xml/ns/public/model/action-3#link</handlerUri>
                    </action>
                </reaction>
                <reaction>
                    <situation>unmatched</situation>
                </reaction>
                <reaction>
                    <situation>deleted</situation>
                    <synchronize>true</synchronize>
                    <action>
                        <handlerUri>http://midpoint.evolveum.com/xml/ns/public/model/action-3#unlink</handlerUri>
                    </action>
                </reaction>
            </objectSynchronization>
            <objectSynchronization>
                <name>Grouper Group</name>
                <kind>generic</kind>
                <objectClass>CustomGroupObjectClass</objectClass>
                <focusType>c:OrgType</focusType>
                <enabled>true</enabled>
                <correlation>
                    <q:equal xmlns="">
                        <q:path>name</q:path>
                        <expression xmlns="">
                            <path>$projection/attributes/groupId</path>
                        </expression>
                    </q:equal>
                </correlation>
                <reaction>
                    <situation>linked</situation>
                    <synchronize>true</synchronize>
                </reaction>
                <reaction>
                    <situation>deleted</situation>
                    <synchronize>true</synchronize>
                    <action>
                        <handlerUri>http://midpoint.evolveum.com/xml/ns/public/model/action-3#deleteFocus</handlerUri>
                        <!-- TODO do we need unlink here and handle deletes via some form of graceful cleanup? -->
                    </action>
                </reaction>
                <reaction>
                    <situation>unlinked</situation>
                    <synchronize>true</synchronize>
                    <action>
                        <handlerUri>http://midpoint.evolveum.com/xml/ns/public/model/action-3#link</handlerUri>
                    </action>
                </reaction>
                <reaction>
                    <situation>unmatched</situation>
                    <synchronize>true</synchronize>
                    <action>
                        <handlerUri>http://midpoint.evolveum.com/xml/ns/public/model/action-3#addFocus</handlerUri>
                    </action>
                </reaction>
            </objectSynchronization>
        </synchronization>
    </resource>
</objects>